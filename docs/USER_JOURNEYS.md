# ATCL SACCOS Membership Referral Portal – User Journeys by Role and Module\n\n## Roles\n\n- **Member**: SACCOS member who registers, logs in, submits and tracks referrals.\n- **Approver**: Staff who reviews and approves/rejects referrals; has access to admin dashboards and queues.\n- **Administrator**: Approver plus full configuration and user management (settings, reports, roles, etc.).\n\n---\n\n## 1. Authentication Module (STORY‑001 – STORY‑004)\n\n### 1.1 Member\n\n- **Register**\n  - Navigate to `/register`.\n  - Fill: name, membership number, email, phone, password, confirm password.\n  - Submit form.\n  - If validation fails → see errors and correct.\n  - On success → account created → redirected to login.\n\n- **Log in**\n  - Go to `/login`.\n  - Enter **email or membership number** and password.\n  - Submit form.\n  - If credentials invalid → see generic error (no hint which field is wrong).\n  - After too many failed attempts (per settings) → account locked for configured duration.\n  - On success → redirected to **Member dashboard** (`/dashboard`).\n\n- **Reset password**\n  - From `/login`, click **“Forgot Password”**.\n  - Enter email address.\n  - Receive reset link via email.\n  - Open link → reset form → set new password + confirmation.\n  - Submit → password updated → can log in with new password.\n\n- **Logout**\n  - While logged in, open profile dropdown in top‑right.\n  - Click **“Log out”**.\n  - Session cleared → redirected to `/login`.\n\n- **Session timeout**\n  - Member stays idle beyond configured **session timeout minutes** (from Admin Settings).\n  - Session expires automatically.\n  - Next navigation or action redirects to `/login` and requires re‑authentication.\n\n### 1.2 Approver / Administrator\n\n- Same registration (if allowed), login, password reset, logout, and session timeout journeys as Member.\n- Difference: after successful login, if role is **approver/administrator**, user is redirected to **Admin dashboard** (`/admin/dashboard`) instead of member dashboard.\n\n---\n\n## 2. Referrals Module (STORY‑005 – STORY‑008)\n\n### 2.1 Member\n\n- **Submit a referral**\n  - From main navigation, click **“Submit referral”** (`/referrals/create`).\n  - Fill form:\n    - Referred full name (required).\n    - Phone and/or email (at least one required).\n    - Relationship to referrer (optional).\n    - Notes (optional).\n  - Submit form.\n  - If name + phone/email missing or invalid → see validation errors and correct.\n  - System generates a unique referral ID using configured prefix + date + sequence.\n  - Referral saved with **status: Pending**, linked to current user as referrer.\n  - See success message with referral ID and options to **view referrals** or **submit another**.\n\n- **Prevent duplicate referral**\n  - From `/referrals/create`, attempt to submit a referral with a phone/email that the same member used before.\n  - System checks existing referrals by current user for same phone/email.\n  - If duplicate detected → display error; referral is not created.\n\n- **View my referrals**\n  - From main nav, click **“My referrals”** (`/referrals`).\n  - See table of own referrals with columns:\n    - Referral ID.\n    - Referred name.\n    - Contact (phone or email).\n    - Date submitted.\n    - Status (Pending, In review, Approved, Rejected).\n  - Use filters:\n    - Status dropdown (All, Pending, In review, Approved, Rejected).\n    - Date range (From, To) to restrict by submission date.\n  - Use sorting controls on columns (e.g. date, name, status).\n  - Use pagination controls to move between pages.\n  - Click **“View”** on a row to open referral detail.\n\n- **View referral detail and history**\n  - From `/referrals`, click a referral.\n  - Land on `/referrals/{referral}`.\n  - See:\n    - Referral core data (ID, referred contact, relationship, notes).\n    - Current status.\n    - History list (status changes with who changed it, when, and comments).\n\n### 2.2 Approver\n\n- **Submit and manage own referrals**\n  - Follows the same **Submit**, **My referrals**, and **Detail** journeys as a Member for their own referrals.\n\n### 2.3 Administrator\n\n- Same referral journeys as Approver/Member for own referrals, plus admin‑side views described in Sections 3 and 6.\n\n---\n\n## 3. Approval Workflow Module (STORY‑009 – STORY‑012)\n\n### 3.1 Approver\n\n- **View pending referrals list**\n  - From admin navigation, click **“Pending referrals”** (`/admin/referrals/pending`).\n  - See list of referrals with status **Pending** or **In review**:\n    - Columns: ID, referred name, contact, referrer name, date submitted, actions.\n  - Use filters:\n    - Date range (From, To).\n    - Referrer (dropdown of referrers with pending items).\n  - Use checkboxes to select one or many referrals.\n\n- **Approve a single referral (from list)**\n  - In the Pending list, on a row with a pending referral, click **“Approve”**.\n  - System:\n    - Updates status to **Approved**.\n    - Records `approved_by` and `approved_at`.\n    - Appends status history entry (from previous status → Approved, changed by approver).\n    - Sends email + in‑app notification + (log‑based) SMS to the referrer.\n  - Approver sees success flash message.\n\n- **Reject a single referral (from list)**\n  - In Pending list, click **“Reject”**.\n  - Modal opens prompting for a rejection reason.\n  - Enter reason (required) and confirm.\n  - System:\n    - Updates status to **Rejected** and stores rejection reason.\n    - Adds status history entry with reason.\n    - Sends email + in‑app notification + SMS to referrer including reason (when present).\n  - Approver sees success message; row status updates on next refresh.\n\n- **Approve or reject from detail**\n  - From Pending list, click referral ID to open `/admin/referrals/{referral}`.\n  - On detail view, use **Approve** or **Reject** buttons.\n  - Approve flow: same state changes and notifications as from list.\n  - Reject flow: opens reason input, then same state changes and notifications.\n\n- **Bulk approve referrals**\n  - On `/admin/referrals/pending`, select multiple referrals using checkboxes.\n  - Click **“Approve X selected”**.\n  - System iterates over selected pending/in‑review referrals:\n    - Updates status to Approved, sets approver and approved_at.\n    - Appends status history with “Bulk approved”.\n    - Sends email + notification + SMS for each.\n  - Selections are cleared; success message shows count approved.\n\n- **Bulk reject referrals**\n  - On `/admin/referrals/pending`, select multiple referrals.\n  - Click **“Reject X selected”**.\n  - Modal opens asking for a **shared rejection reason** (required).\n  - Upon confirmation, system:\n    - Updates each selected referral to Rejected with shared reason.\n    - Adds status history entries (comment = shared reason).\n    - Sends email + notification + SMS to each referrer.\n  - Selections cleared; success message shows count rejected.\n\n### 3.2 Administrator\n\n- Same approval journeys as Approver.\n\n- **View all referrals (not only pending)**\n  - Admin nav → **“All referrals”** (`/admin/referrals/all`).\n  - Journeys:\n    - Filter by status (All, Pending, In review, Approved, Rejected).\n    - Filter by date range and by referrer.\n    - Sort by ID, status, referrer, created date.\n    - Click a referral to open the shared detail view (same as for member/approver).\n\n### 3.3 Member\n\n- Cannot approve or reject.\n- Can always see the latest status and full history for their **own** referrals (see Module 2).\n\n---\n\n## 4. Dashboards Module (STORY‑013 – STORY‑014)\n\n### 4.1 Member Dashboard\n\n- **View dashboard after login**\n  - After successful login as Member, redirected to `/dashboard`.\n  - Sees:\n    - **Summary cards**: total referrals, pending, approved, rejected.\n    - **Referrals over time**: counts per month, last 6 months.\n    - **Recent referrals**: list of latest referrals with status.\n    - **Submit referral** button → `/referrals/create`.\n\n### 4.2 Admin Dashboard (Approver & Administrator)\n\n- **View admin dashboard after login**\n  - After login as Approver/Administrator, redirected to `/admin/dashboard`.\n  - Sees:\n    - Summary cards for **Total, Pending, Approved, Rejected**.\n    - Pending count as a link to **Pending referrals** page.\n    - **Referrals over time** panel:\n      - A period dropdown with options: Daily (last 30 days), Monthly (last 6 months), Annual (last 5 years).\n      - Trend list showing bucket label (date/month/year) and count for that bucket.\n    - **Top referrers** list: member names and referral counts.\n\n- **Change trend period**\n  - On `/admin/dashboard`, use the period dropdown to switch between **Daily**, **Monthly**, and **Annual**.\n  - Trend section reloads to show counts grouped by selected period.\n\n---\n\n## 5. Notifications Module (STORY‑015 – STORY‑017)\n\n### 5.1 All Roles (when logged in)\n\n- **Receive email notifications**\n  - When any of the user’s referrals is approved or rejected:\n    - System sends email with subject and body summarising outcome.\n    - For rejections, includes rejection reason when available.\n\n- **Receive SMS notifications (when enabled)**\n  - Admin can toggle SMS notifications in **Settings**.\n  - If SMS notifications are enabled and the user has a phone number:\n    - Approve/reject operations trigger an SMS via `SmsService` (currently logged; ready for real gateway).\n\n- **View in‑app notifications**\n  - On any authenticated page, see a bell icon in the header.\n  - Badge on bell shows unread notification count.\n\n- **Interact with notification dropdown**\n  - Click bell → opens dropdown listing recent notifications:\n    - Each entry shows a concise message (e.g. “Referral REF‑... was approved”) and relative time.\n    - Each entry links to the associated referral detail.\n  - Clicking an entry:\n    - Marks that notification as **read**.\n    - Navigates to `/referrals/{referral}`.\n\n- **Mark all as read**\n  - In dropdown header, click **“Mark all read”**.\n  - All unread notifications for the user are marked as read; badge count resets.\n\n---\n\n## 6. Administration Module (STORY‑018 – STORY‑020)\n\n### 6.1 Administrator\n\n- **Access admin area**\n  - Log in as a user with role **administrator**.\n  - Redirected to `/admin/dashboard`.\n  - Use admin navigation (top or side) to access sub‑modules.\n\n- **Manage users and roles**\n  - Navigate: Admin nav → **“Users”** (`/admin/users`).\n  - Journeys:\n    - Search users by name, email, membership number.\n    - Filter by role (Member, Approver, Administrator).\n    - For any user other than self:\n      - Use role dropdown to change role.\n      - Use access toggle to enable/disable portal access (`is_active`).\n    - See flash messages confirming role or access changes.\n\n- **Configure system and notifications**\n  - Navigate: Admin nav → **“Settings”** (`/admin/settings`).\n  - Journeys:\n    - Set **Referral ID prefix** (used in ID generation).\n    - Set **Lockout attempts** (per minute for rate limiting & lockout threshold).\n    - Set **Session timeout (minutes)** (applied to session lifetime).\n    - Enable/disable **Email notifications**.\n    - Enable/disable **SMS notifications**.\n    - Click **Save settings** → settings persisted and used at runtime.\n\n### 6.2 Approver\n\n- Shares admin shell for **Dashboard**, **Pending Referrals**, **All Referrals**, and **Reports**.\n- Does **not** see or use **Users** and **Settings** unless their role is also administrator.\n\n### 6.3 Member\n\n- No journeys inside `/admin/*` routes; all admin URLs are protected by middleware.\n\n---\n\n## 7. Reports & Export Module (STORY‑021 – STORY‑022)\n\n### 7.1 Administrator (and Approver where allowed)\n\n- **Run referral summary report**\n  - Admin nav → **“Reports”** (`/admin/reports`).\n  - Journeys:\n    - Choose **period** (daily/monthly/annual) from dropdown.\n    - Choose **Date from** and **Date to**.\n    - View summary cards for the chosen range:\n      - Total referrals, Pending, Approved, Rejected.\n\n- **Export referrals as CSV**\n  - On the Reports page, click **“Export CSV”**.\n  - A CSV file downloads with referral data for the selected date range.\n\n- **Explore all referrals with filters and export**\n  - Admin nav → **“All referrals”** (`/admin/referrals/all`).\n  - Journeys:\n    - Apply filters (status/date/referrer) to refine on‑screen list.\n    - Click **“Export CSV”** (date‑based export via Reports controller).\n\n### 7.2 Member\n\n- No direct journeys in Reports; uses personal dashboard and My Referrals only.\n\n---\n\n## 8. UI Shell, Security, and Technical Journeys (STORY‑023 – STORY‑028)\n\n### 8.1 Responsive navigation and layout (all roles)\n\n- On desktop widths:\n  - Main navigation shows Dashboard, My referrals, Submit referral; additional Admin links for approvers/admins.\n- On mobile widths:\n  - Hamburger icon toggles responsive nav.\n  - Links to Dashboard, My referrals, Submit referral, and the appropriate admin pages (Dashboard, Pending, All referrals, Reports, Users, Settings for administrators).\n\n### 8.2 Security & compliance (implicit journeys)\n\n- **Unauthorized access**\n  - If a non‑admin tries to hit `/admin/*` manually, they see a 403 or redirect.\n  - If a guest hits any authenticated route, they are redirected to `/login`.\n\n- **Account state**\n  - If an administrator disables a user or the account is in lockout, login attempts fail until re‑enabled/unlocked.\n\n### 8.3 Backup, documentation, integration (future journeys)\n\n- **Backup & recovery (STORY‑025)**\n  - Planned journeys for the future:\n    - Ops/admin documentation to run DB backups and restore.\n    - Optional UI trigger under Settings.\n\n- **Documentation & handover (STORY‑027)**\n  - Final deliverables to include:\n    - User guide (member journeys).\n    - Admin guide (admin/approver journeys, reports, settings, roles).\n\n- **Integration (STORY‑028)**\n  - Future journeys around:\n    - Configuring and testing member validation API.\n    - Exporting approved referrals for downstream systems.\n\nThis file describes the intended and implemented user journeys for each role across all modules, aligned with `docs/ATCLSACCOS_PRD.json`.\n*** End Patch"} ***!
